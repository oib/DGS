// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Level and XP
  level         Int       @default(1)
  xp            Int       @default(0)
  totalXp       Int       @default(0)
  
  // Login stats
  loginCount    Int       @default(0)
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  
  // Relations
  userTestResults UserTestResult[]
  userProgress    UserProgress[]
  achievements    UserAchievement[]
  loginStats      LoginStat[]
  
  @@map("users")
}

model LoginStat {
  id        String   @id @default(cuid())
  userId    String
  loginAt   DateTime @default(now())
  ipAddress String?
  userAgent String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("login_stats")
}

model Level {
  id          Int @id
  name        String
  minXp       Int
  maxXp       Int
  badgeUrl    String?
  description String?
  
  @@map("levels")
}

model Test {
  id          String   @id @default(cuid())
  title       String
  description String?
  level       Int      @default(1)
  category    String?
  timeLimit   Int?     // in minutes
  passingScore Int     @default(70) // percentage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  questions    Question[]
  userTestResults UserTestResult[]
  
  @@map("tests")
}

model Question {
  id          String   @id @default(cuid())
  testId      String
  text        String
  imageUrl    String?  // for image questions
  order       Int
  points      Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  test        Test @relation(fields: [testId], references: [id], onDelete: Cascade)
  options     Option[]
  userAnswers UserAnswer[]
  
  @@map("questions")
}

model Option {
  id         String @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)
  order      Int
  
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userAnswers UserAnswer[]
  
  @@map("options")
}

model UserTestResult {
  id          String   @id @default(cuid())
  userId      String
  testId      String
  score       Int      // percentage
  totalPoints Int
  earnedPoints Int
  timeSpent   Int      // in seconds
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Relations
  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  test    Test @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers UserAnswer[]
  
  @@map("user_test_results")
}

model UserAnswer {
  id              String @id @default(cuid())
  userTestResultId String
  questionId      String
  selectedOptionId String
  isCorrect       Boolean
  pointsEarned    Int
  
  userTestResult UserTestResult @relation(fields: [userTestResultId], references: [id], onDelete: Cascade)
  question       Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption Option @relation(fields: [selectedOptionId], references: [id], onDelete: Cascade)
  
  @@map("user_answers")
}

model UserProgress {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String?
  vocabularyId  String?
  completed     Boolean  @default(false)
  score         Int?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_progress")
}

model Achievement {
  id          String @id @default(cuid())
  name        String
  description String
  iconUrl     String?
  xpReward    Int     @default(0)
  condition   String?  // conditions to unlock (JSON string)

  userAchievements UserAchievement[]

  @@map("achievements")
}

model Category {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  words       Word[]

  @@map("categories")
}

model VocabularyLevel {
  id          Int @id
  name        String
  description String?
  words       Word[]

  @@map("vocabulary_levels")
}

model Word {
  id          String @id @default(cuid())
  german      String
  english     String
  description String
  difficulty  Int
  categoryId  String
  levelId     Int

  category Category @relation(fields: [categoryId], references: [id])
  level    VocabularyLevel    @relation(fields: [levelId], references: [id])

  // Search index
  @@index([german])
  @@index([english])
  @@index([categoryId])
  @@index([levelId])
  @@map("words")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Translation {
  id          String @id @default(cuid())
  key         String
  language    String
  value       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, language])
  @@map("translations")
}
